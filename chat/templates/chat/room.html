<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
    
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat Room</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="icon" href="/static/img/cropped-favicon-192x192.webp">
        
</head>
<body class=" mx-auto bg-dark" style="position:relative; overflow: hidden; " >
    {% include "site_cuisineries/navbar.html" %}
    <header >
        <div>
            <h5 class="text-center" style="color:#b0cfc0;">Conversation entre {{ pers1.first_name }} {{ pers1.last_name }} et {{ pers2.first_name }} {{ pers2.last_name }} :</h5>
            
        </div>
    </header>
       
        <div class="card  mx-auto bg-dark" style="overflow-y: scroll; height: 85vh; " >
            <div class="card-body" >
                <div id="chat-log"> 
                {% if message_list %}
                {% for txt in message_list %}
                    {% if txt.sender_id == request.user.id %}
                    
                    <div class="d-flex flex-row justify-content-end mb-3">
                        <div class="p-1 ms-1 bg-secondary" style="border-radius: 15px;color:white; "><div class="small mb-0" style="padding: .5em;">{{ txt.message}}</div></div>
                        
                        <img class="rounded" src="/static/profils/{{txt.sender_id}}.png" style="padding: .2em;" alt="..." width="40" height="40">
                    <br>
                        </div>
                    {% else %}
                    <div class="d-flex flex-row justify-content-start mb-3" >
                        {% if pers1 == request.user %}
                        <img class="rounded" src="/static/profils/{{txt.sender_id}}.png" alt="..." style="padding: .2em;" width="40" height="40" >
                        {% else %}
                        <img class="rounded" src="/static/profils/{{txt.sender_id}}.png" alt="..." style="padding: .2em;" width="40" height="40" >
                        {% endif %}
                        <div class="p-1 me-1 " style="border-radius: 15px;background-color: #b0cfc0; "><div class="small mb-0 " style="padding: .5em;">{{ txt.message}}</div></div>
                        <br></div>
                    {% endif %}
                {% endfor %}
                {% endif %}
            </div>
            <div></div>
            
                
            </div>
        </div>
        <footer style="padding-top:1em">
            <div style="position:fixed;bottom:0;">
                <form class="row mx-auto" onkeydown="return event.key != 'Enter';" >
                    
                       <div class="form-group col">
                            <input id="chat-message-input" placeholder="Envoyer un message"  style="bottom:0;"class="form-control mb-2" type="text" size="150"> 
                        </div>
                        <div class="col"><input id="chat-message-submit"  class="btn btn-secondary mx-sm-2 mb-2" type="button" value="OK"></div>
                            
                    
                        
                  </form>
                
                
            </div>
        </footer>
       
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <script>
        const roomName = "{{room_name}}";
        document.getElementsByClassName('card')[0].scrollTo(0, document.getElementsByClassName('card')[0].scrollHeight)
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );


        chatSocket.onmessage = function(e) {    
            const data = JSON.parse(e.data);
            

            if(data.sender == {{request.user.id}}) {
                document.querySelector('#chat-log').innerHTML +=  '<div class="d-flex flex-row justify-content-end mb-3"><div class="p-1 ms-1 bg-secondary" style="border-radius: 15px; "><div class="small mb-0" style="padding: .5em;color:white;">'+data.message+'</div></div><img class="rounded" src="/static/profils/'+data.sender+'.png" style="padding: .2em;" alt="..." width="40" height="40"><br><div>';
            }
            else {
                document.querySelector('#chat-log').innerHTML +=  '<div class="d-flex flex-row justify-content-start mb-3" ><img class="rounded" src="/static/profils/'+data.sender+'.png"+" alt="..." style="padding: .2em;" width="40" height="40" ><div class="p-1 me-1 " style="border-radius: 15px;background-color: #b0cfc0; "><div class="small mb-0 " style="padding: .5em;">'+data.message+'</div></div><br></div>';
                chatSocket.send(JSON.stringify({
                    'type':'read',
                    'message': data.id,
                    'id' : {{request.user.id}}
                }));
            }
                


           };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            if(message!=""){
                chatSocket.send(JSON.stringify({
                'type':'message',
                'message': message,
                'sender' : {{request.user.id}}
            }));
            }
            
            messageInputDom.value = '';
        };
    </script>
</body>
</html>