<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Contreparties</title>
    <link href="/static/css/calendar.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
        <link rel="icon" href="/static/img/cropped-favicon-192x192.webp">
</head>

<body style="background-color: #E7DBCB; min-height: 100vh; background-image: url(/static/img/Ronds_petits.png), url(/static/img/Ronds_moyens.png);
background-repeat-x: no-repeat;
background-repeat-y: no-repeat;
background-position-y: bottom; background-position-x: left, right;">
    {% include "site_cuisineries/navbar.html" %}
    <div class="container d-lg-flex " style="margin-top: 3rem;">
        <div class="col col-lg-2"></div>
        <div class="col col-lg-8">
            <div class="alert alert-primary d-flex align-items-center" role="alert">
                <div>
                    Crédits disponibles : <span id="credits">{{request.user.credits}}</span>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% csrf_token %}
                {% for contrepartie in contrepartie_data %}
                <div class="col">
                    <div class="card">
                        <h5 class="card-header" id="title_{{contrepartie.id}}">{{contrepartie.nom}}</h5>
                        <div class="card-body">
                            <h5 class="card-title">Crédits requis : <span id="credits_{{contrepartie.id}}">{{contrepartie.credits_requis}}</span></h5>
                            <p class="card-text">{{contrepartie.details}}</p>
                            {% if request.user.credits >= contrepartie.credits_requis %}
                            <button type="button" onclick="select({{contrepartie.id}})" data-bs-toggle="modal" data-bs-target="#confirmModal" href="#" class="btn btn-primary">Sélectionner</a>
                            {% else %}
                            <button type="button" href="#" disabled class="btn btn-secondary">Sélectionner</a>
                            {% endif %}
                        </div>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" id="quantite_{{contrepartie.id}}">
                            {{contrepartie.quantite_dispo}}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="col col-lg-2"></div>
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="confirmModalLabel"></h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  Êtes vous sûr de votre choix ?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelButton">Annuler</button>
                  <button type="button" class="btn btn-primary" id="confirmButton">Confirmer</button>
                </div>
              </div>
            </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="resultToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-header" id="toast-header">
                <strong class="me-auto" id="resultToastTitle"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body" id="resultToastText">
              </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
        <script type="text/javascript">
            function select(id){
                document.getElementById("confirmModalLabel").innerText = document.getElementById("title_"+id).innerText;
                document.getElementById("confirmButton").setAttribute("onclick", "confirmChoix("+id+")");
            }

            function confirmChoix(id){
                document.getElementById('confirmButton').setAttribute("disabled", "disabled");
                document.getElementById('confirmButton').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Confirmer';

                let form = new FormData();
                form.append("id_contrepartie", id);

                let csrfTokenValue = document.querySelector('[name=csrfmiddlewaretoken]').value;
                let request = new Request("/ajax/choixContrepartie", {method: 'POST',
                                                            body: form,
                                                            headers: {"X-CSRFToken": csrfTokenValue}})
                fetch(request)
                    .then(response => response.json())
                    .then(result => {
                        if(result.result){
                            document.getElementById("quantite_"+id).innerText = parseInt(document.getElementById("quantite_"+id).innerText)-1;
                            document.getElementById("credits").innerText = parseInt(document.getElementById("credits").innerText)-parseInt(document.getElementById("credits_"+id).innerText);
                            document.getElementById("resultToastTitle").innerText = "Confirmée !";
                            document.getElementById("resultToastText").innerText = "Votre choix de contrepartie a été validée !";
                            document.getElementById("toast-header").style.backgroundColor = "var(--bs-success)";
                            document.getElementById("toast-header").style.color = "white";
                            document.getElementById("resultToastText").backgroundColor = "var(--bs-success-bg-subtle)";
                        }else{
                            document.getElementById("resultToastTitle").innerText = "Erreur !";
                            document.getElementById("resultToastText").innerText = result.Erreur;
                            document.getElementById("toast-header").style.backgroundColor = "var(--bs-danger)";
                            document.getElementById("toast-header").style.color = "white";
                            document.getElementById("resultToastText").backgroundColor = "var(--bs-danger-bg-subtle)";
                        }
                        document.getElementById("cancelButton").click();
                        document.getElementById('confirmButton').removeAttribute("disabled");
                        document.getElementById('confirmButton').innerHTML = 'Confirmer';
                        const toast = new bootstrap.Toast(document.getElementById("resultToast"));
                        toast.show();
                });
            }
        </script>
</body>

</html>